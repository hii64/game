<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>オセロ（自分 vs AI）</title>
<style>
  body { font-family: sans-serif; text-align: center; }
  table { border-collapse: collapse; margin: 20px auto; }
  td {
    width: 40px; height: 40px;
    border: 1px solid #444;
    background-color: green;
    cursor: pointer;
  }
  .black, .white {
    width: 30px; height: 30px;
    border-radius: 50%;
    margin: auto;
    margin-top: 4px;
  }
  .black { background-color: black; }
  .white { background-color: white; }
  #message { font-size: 1.2em; margin-top: 10px; }
</style>
</head>
<body>

<h1>オセロ（あなた vs AI）</h1>
<div id="message">あなたの番（黒）です</div>
<table id="board"></table>

<script>
  const SIZE = 8;
  const EMPTY = 0, BLACK = 1, WHITE = 2;
  let board = [];
  let currentPlayer = BLACK;

  const boardElem = document.getElementById('board');
  const messageElem = document.getElementById('message');

  const directions = [
    [-1, -1], [-1, 0], [-1, 1],
    [0, -1],          [0, 1],
    [1, -1], [1, 0],  [1, 1]
  ];

  function initBoard() {
    board = Array.from({ length: SIZE }, () => Array(SIZE).fill(EMPTY));
    board[3][3] = WHITE;
    board[3][4] = BLACK;
    board[4][3] = BLACK;
    board[4][4] = WHITE;
  }

  function createBoard() {
    boardElem.innerHTML = '';
    for (let x = 0; x < SIZE; x++) {
      const row = document.createElement('tr');
      for (let y = 0; y < SIZE; y++) {
        const cell = document.createElement('td');
        cell.dataset.x = x;
        cell.dataset.y = y;
        cell.addEventListener('click', () => handlePlayerMove(x, y));
        row.appendChild(cell);
      }
      boardElem.appendChild(row);
    }
    updateBoard();
  }

  function updateBoard() {
    for (let x = 0; x < SIZE; x++) {
      for (let y = 0; y < SIZE; y++) {
        const cell = boardElem.rows[x].cells[y];
        cell.innerHTML = '';
        if (board[x][y] === BLACK) {
          const disc = document.createElement('div');
          disc.className = 'black';
          cell.appendChild(disc);
        } else if (board[x][y] === WHITE) {
          const disc = document.createElement('div');
          disc.className = 'white';
          cell.appendChild(disc);
        }
      }
    }
  }

  function isOnBoard(x, y) {
    return x >= 0 && x < SIZE && y >= 0 && y < SIZE;
  }

  function opponent(p) {
    return p === BLACK ? WHITE : BLACK;
  }

  function getFlips(x, y, player) {
    if (board[x][y] !== EMPTY) return [];
    let flips = [];
    for (const [dx, dy] of directions) {
      let nx = x + dx, ny = y + dy;
      let line = [];
      while (isOnBoard(nx, ny) && board[nx][ny] === opponent(player)) {
        line.push([nx, ny]);
        nx += dx;
        ny += dy;
      }
      if (isOnBoard(nx, ny) && board[nx][ny] === player && line.length > 0) {
        flips = flips.concat(line);
      }
    }
    return flips;
  }

  function getValidMoves(player) {
    let moves = [];
    for (let x = 0; x < SIZE; x++) {
      for (let y = 0; y < SIZE; y++) {
        if (getFlips(x, y, player).length > 0) {
          moves.push([x, y]);
        }
      }
    }
    return moves;
  }

  function makeMove(x, y, player) {
    const flips = getFlips(x, y, player);
    if (flips.length === 0) return false;
    board[x][y] = player;
    for (const [fx, fy] of flips) {
      board[fx][fy] = player;
    }
    return true;
  }

  function handlePlayerMove(x, y) {
    if (currentPlayer !== BLACK) return;
    if (!makeMove(x, y, BLACK)) return;
    currentPlayer = WHITE;
    updateBoard();
    if (checkGameOver()) return;
    setTimeout(aiTurn, 500);
  }

  function aiTurn() {
    const moves = getValidMoves(WHITE);
    if (moves.length === 0) {
      currentPlayer = BLACK;
      updateMessage();
      return;
    }
    // AI: ランダムな手を選ぶ
    const [x, y] = moves[Math.floor(Math.random() * moves.length)];
    makeMove(x, y, WHITE);
    currentPlayer = BLACK;
    updateBoard();
    checkGameOver();
  }

  function checkGameOver() {
    const blackMoves = getValidMoves(BLACK);
    const whiteMoves = getValidMoves(WHITE);

    if (blackMoves.length === 0 && whiteMoves.length === 0) {
      const [b, w] = countDiscs();
      if (b > w) {
        messageElem.textContent = `ゲーム終了：あなた（黒）の勝ち！ B:${b} W:${w}`;
      } else if (w > b) {
        messageElem.textContent = `ゲーム終了：AI（白）の勝ち！ B:${b} W:${w}`;
      } else {
        messageElem.textContent = `引き分け！ B:${b} W:${w}`;
      }
      return true;
    }

    if (currentPlayer === BLACK && blackMoves.length === 0) {
      alert("あなたはパスされました。");
      currentPlayer = WHITE;
      setTimeout(aiTurn, 500);
      return false;
    }

    if (currentPlayer === WHITE && whiteMoves.length === 0) {
      alert("AIはパスしました。");
      currentPlayer = BLACK;
      updateMessage();
      return false;
    }

    updateMessage();
    return false;
  }

  function countDiscs() {
    let b = 0, w = 0;
    for (let x = 0; x < SIZE; x++) {
      for (let y = 0; y < SIZE; y++) {
        if (board[x][y] === BLACK) b++;
        if (board[x][y] === WHITE) w++;
      }
    }
    return [b, w];
  }

  function updateMessage() {
    messageElem.textContent = currentPlayer === BLACK ? 'あなたの番（黒）です' : 'AIの番（白）です';
  }

  // スタート！
  initBoard();
  createBoard();
</script>

</body>
</html>
